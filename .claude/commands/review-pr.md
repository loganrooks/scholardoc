---
description: Review a GitHub PR with AI agents and post findings to GitHub
allowed-tools: Bash(gh:*), Bash(git:*), Bash(jq:*), Bash(mktemp:*), Bash(rm:*), Bash(cat:*), Read, Write, Task, TodoWrite
argument-hint: <PR-number> [--approve-if-clean] [--dry-run]
---

# Review PR: $ARGUMENTS

**MODE: GITHUB-INTEGRATED CODE REVIEW**

You are performing an AI-assisted code review that posts findings directly to GitHub.

---

## Phase 0: Parse Arguments

```
PR_NUMBER = first numeric argument from $ARGUMENTS
FLAGS:
  --approve-if-clean : Auto-approve if no issues found
  --dry-run          : Generate review but don't post to GitHub
```

---

## Phase 1: Fetch PR Context

### 1.1 Verify PR Exists and Get Metadata

```bash
gh pr view $PR_NUMBER --json number,title,author,baseRefName,headRefName,body,additions,deletions,changedFiles,state
```

**STOP if**: PR not found, already merged, or closed.

### 1.2 Get Changed Files

```bash
gh pr view $PR_NUMBER --json files --jq '.files[].path'
```

### 1.3 Get Full Diff

```bash
gh pr diff $PR_NUMBER
```

### 1.4 Get Existing Reviews (Avoid Duplicates)

```bash
gh pr view $PR_NUMBER --json reviews --jq '.reviews[] | {author: .author.login, state: .state, body: .body}'
```

Check if a recent AI review already exists (within last hour). If so, ask user whether to proceed.

---

## Phase 2: Analyze Changes

### 2.1 Prepare Review Context

Create a structured summary for the reviewer agent:

```markdown
## PR #[NUMBER]: [TITLE]

**Author**: [author]
**Base**: [baseRefName] â† **Head**: [headRefName]
**Stats**: +[additions] -[deletions] across [changedFiles] files

### Description
[PR body]

### Files Changed
[List of files]

### Diff
[Full diff content]
```

### 2.2 Launch Code Reviewer Agent

```
Task: code-reviewer agent

Prompt:
---
Review this pull request for bugs, security issues, performance problems, and adherence to project standards.

[Include PR context from 2.1]

For each issue found, specify:
- File path
- Line number (from diff, using +/- notation)
- Severity (critical/major/minor/suggestion)
- Description of issue
- Suggested fix

Output your findings in this exact JSON format:
{
  "verdict": "APPROVE" | "REQUEST_CHANGES" | "COMMENT",
  "summary": "Brief overall assessment",
  "issues": [
    {
      "path": "src/auth.ts",
      "line": 42,
      "side": "RIGHT",
      "severity": "major",
      "body": "Potential null pointer: `user.data` accessed without null check"
    }
  ],
  "positives": ["List of good practices observed"],
  "suggestions": ["Optional improvements, not blocking"]
}
---
```

### 2.3 Parse Agent Response

Extract the structured JSON from the agent's response. Validate required fields.

---

## Phase 3: Prepare GitHub Review

### 3.1 Map Verdict to GitHub Review Event

| Agent Verdict | GitHub Event | Condition |
|---------------|--------------|-----------|
| APPROVE | APPROVE | No critical/major issues |
| REQUEST_CHANGES | REQUEST_CHANGES | Has critical/major issues |
| COMMENT | COMMENT | Only minor/suggestions |

### 3.2 Format Review Body

```markdown
## ðŸ¤– AI Code Review

**Verdict**: [VERDICT_EMOJI] [VERDICT]

### Summary
[Agent summary]

### Issues Found
| Severity | File | Line | Issue |
|----------|------|------|-------|
[Table of issues]

### Positive Observations
[List of positives]

### Suggestions (Non-blocking)
[List of suggestions]

---
*Review generated by autonomous code reviewer agent*
```

### 3.3 Prepare Line Comments

For each issue with a specific line number, prepare a review comment:

```json
{
  "path": "src/auth.ts",
  "line": 42,
  "side": "RIGHT",
  "body": "ðŸ”´ **Major**: Potential null pointer - `user.data` accessed without null check.\n\nSuggested fix:\n```typescript\nif (user?.data) {\n  // safe to access\n}\n```"
}
```

---

## Phase 4: Post to GitHub

### 4.1 Dry Run Check

```
IF --dry-run flag set:
  Output: "DRY RUN - Would post the following review:"
  Display formatted review
  Display line comments that would be added
  STOP here
```

### 4.2 Create Review with Line Comments

Use GitHub API to post review with inline comments:

```bash
# Create temp file for review payload
PAYLOAD=$(mktemp)

cat > $PAYLOAD << 'REVIEW_EOF'
{
  "body": "[FORMATTED_REVIEW_BODY]",
  "event": "[APPROVE|REQUEST_CHANGES|COMMENT]",
  "comments": [
    {
      "path": "src/auth.ts",
      "line": 42,
      "side": "RIGHT",
      "body": "Issue description..."
    }
  ]
}
REVIEW_EOF

# Post review via API
gh api repos/{owner}/{repo}/pulls/$PR_NUMBER/reviews \
  --input $PAYLOAD

rm $PAYLOAD
```

### 4.3 Alternative: Simple Review (No Line Comments)

If line comment mapping fails, fall back to simple review:

```bash
gh pr review $PR_NUMBER --[approve|request-changes|comment] --body "[REVIEW_BODY]"
```

---

## Phase 5: Report

### 5.1 Success Output

```markdown
## âœ… PR Review Posted

**PR**: #[NUMBER] - [TITLE]
**Verdict**: [VERDICT]
**Issues**: [COUNT] ([CRITICAL] critical, [MAJOR] major, [MINOR] minor)
**Line Comments**: [COUNT] posted

ðŸ”— [View on GitHub](PR_URL)
```

### 5.2 Update Signals (Optional)

If review found issues, optionally capture as signal for self-improvement:

```bash
echo '{"ts": "[TIMESTAMP]", "type": "pr_review", "pr": [NUMBER], "issues": [COUNT]}' >> .claude/signals/reviews.jsonl
```

---

## Error Handling

| Error | Action |
|-------|--------|
| PR not found | Exit with clear message |
| Already reviewed recently | Ask user to confirm re-review |
| API rate limit | Wait and retry, or exit with message |
| Agent timeout | Fall back to basic review |
| Line mapping failed | Post review without inline comments |

---

## Examples

```bash
# Basic review
/project:review-pr 42

# Auto-approve if no issues
/project:review-pr 42 --approve-if-clean

# Preview without posting
/project:review-pr 42 --dry-run

# Review with verbose output
/project:review-pr 42 --verbose
```

---

## Security Considerations

- Never include secrets/tokens in review comments
- Sanitize file paths before posting
- Rate limit reviews to prevent spam (max 1 per PR per hour unless forced)
- Don't post reviews to PRs in repos you don't own unless explicitly confirmed

---

## Integration Points

| Command | Integration |
|---------|-------------|
| `/project:auto` | Can trigger review-pr after pushing changes |
| `/project:improve` | Learns from review patterns in `reviews.jsonl` |
| `/project:init` | Detects if repo has PR review requirements |

---

## Configuration (Future)

Could support `.claude/review-config.json`:

```json
{
  "autoApprove": false,
  "requireSecurityCheck": true,
  "ignorePaths": ["*.md", "docs/*"],
  "severityThreshold": "minor",
  "customChecks": ["no-console-log", "require-tests"]
}
```
