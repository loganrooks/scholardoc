{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "ScholarDoc Ground Truth Schema v4 (Comprehensive)",
  "description": "Unified schema for all Phase 2 features: footnotes, endnotes, citations, bibliography, tables",
  "version": "4.0.0",

  "changelog": {
    "v4.0.0": {
      "date": "2026-01-06",
      "changes": [
        "Unified schema for all extraction features",
        "Added document-level metadata for feature presence",
        "Added citation and bibliography sections",
        "Added negative example support (pages without features)",
        "Added table extraction placeholders",
        "Added cross-reference support",
        "Designed for comprehensive labeling to avoid re-exploration"
      ]
    }
  },

  "type": "object",
  "required": ["document_id", "pdf_file", "document_metadata", "page_annotations"],

  "properties": {
    "document_id": {
      "type": "string",
      "description": "Unique identifier for this document (e.g., 'kant_critique_of_judgement')"
    },
    "pdf_file": {
      "type": "string",
      "description": "Path to PDF relative to project root"
    },

    "document_metadata": {
      "type": "object",
      "description": "Document-level information about feature presence",
      "required": ["total_pages", "verified_by", "created_date"],
      "properties": {
        "title": {"type": "string"},
        "author": {"type": "string"},
        "translator": {"type": "string"},
        "editor": {"type": "string"},
        "publisher": {"type": "string"},
        "year": {"type": "integer"},
        "total_pages": {"type": "integer"},
        "created_date": {"type": "string", "format": "date"},
        "verified_by": {
          "type": "string",
          "enum": ["human", "human_spot_check", "claude_opus", "claude_haiku", "automated"]
        },
        "verification_notes": {"type": "string"},

        "feature_summary": {
          "type": "object",
          "description": "Quick lookup for what features this document has",
          "properties": {
            "has_footnotes": {"type": "boolean"},
            "has_endnotes": {"type": "boolean"},
            "has_bibliography": {"type": "boolean"},
            "has_tables": {"type": "boolean"},
            "has_citations": {"type": "boolean"},
            "has_cross_references": {"type": "boolean"},
            "ocr_source": {
              "type": "string",
              "enum": ["born_digital", "adobe_paper_capture", "tesseract", "abbyy", "unknown"]
            }
          }
        },

        "note_schema": {
          "type": "object",
          "description": "Document-wide note marker conventions",
          "properties": {
            "author_note_markers": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Markers used for author notes (e.g., ['*', '†', '‡'])"
            },
            "translator_note_markers": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Markers used for translator notes (e.g., ['a', 'b', 'c'])"
            },
            "editor_note_markers": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Markers used for editor notes (e.g., ['1', '2', '3'])"
            },
            "schema_confidence": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "How confident we are in this schema interpretation"
            },
            "schema_notes": {"type": "string"}
          }
        },

        "endnote_section": {
          "type": "object",
          "description": "Location of endnotes if present",
          "properties": {
            "start_page": {"type": "integer"},
            "end_page": {"type": "integer"},
            "organization": {
              "type": "string",
              "enum": ["by_chapter", "continuous", "by_section"]
            }
          }
        },

        "bibliography_section": {
          "type": "object",
          "description": "Location of bibliography/works cited",
          "properties": {
            "start_page": {"type": "integer"},
            "end_page": {"type": "integer"},
            "citation_style": {
              "type": "string",
              "enum": ["chicago", "mla", "apa", "harvard", "custom", "unknown"]
            },
            "entry_count_estimate": {"type": "integer"}
          }
        }
      }
    },

    "page_annotations": {
      "type": "array",
      "description": "Per-page annotations for sampled pages",
      "items": {"$ref": "#/definitions/page_annotation"}
    },

    "bibliography_entries": {
      "type": "array",
      "description": "Parsed bibliography entries (if bibliography present)",
      "items": {"$ref": "#/definitions/bibliography_entry"}
    }
  },

  "definitions": {
    "page_annotation": {
      "type": "object",
      "required": ["page_index", "page_label", "has_footnotes", "has_citations"],
      "properties": {
        "page_index": {
          "type": "integer",
          "description": "0-indexed page number in PDF"
        },
        "page_label": {
          "type": "string",
          "description": "Printed page number (e.g., 'xxi', '64', 'A23')"
        },
        "verified_by": {
          "type": "string",
          "enum": ["human", "claude_opus", "claude_haiku", "automated"]
        },

        "has_footnotes": {"type": "boolean"},
        "has_citations": {"type": "boolean"},
        "has_tables": {"type": "boolean"},
        "has_cross_references": {"type": "boolean"},
        "is_negative_example": {
          "type": "boolean",
          "description": "True if this page was specifically chosen as having NO features (for false positive testing)"
        },

        "footnotes": {
          "type": "array",
          "items": {"$ref": "#/definitions/footnote"}
        },

        "citations": {
          "type": "array",
          "items": {"$ref": "#/definitions/citation"}
        },

        "tables": {
          "type": "array",
          "items": {"$ref": "#/definitions/table"}
        },

        "cross_references": {
          "type": "array",
          "items": {"$ref": "#/definitions/cross_reference"}
        },

        "ocr_quality": {
          "type": "string",
          "enum": ["good", "marginal", "bad"],
          "description": "OCR quality for this page"
        },

        "special_features": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Notable characteristics (e.g., 'multi_page_continuation', 'symbol_corruption', 'mixed_schemas')"
        },

        "notes": {"type": "string"}
      }
    },

    "footnote": {
      "type": "object",
      "required": ["marker", "source", "location"],
      "properties": {
        "marker": {
          "type": "object",
          "required": ["symbol", "marker_type"],
          "properties": {
            "symbol": {
              "type": "string",
              "description": "The actual marker (*, †, 1, a, etc.)"
            },
            "marker_type": {
              "type": "string",
              "enum": ["symbolic", "numeric", "alphabetic", "roman"]
            },
            "bbox": {
              "type": "array",
              "items": {"type": "number"},
              "minItems": 4,
              "maxItems": 4
            },
            "context_before": {"type": "string"},
            "context_after": {"type": "string"},
            "corruption": {
              "type": "object",
              "properties": {
                "extracted_as": {"type": "string"},
                "is_corrupted": {"type": "boolean"}
              }
            }
          }
        },

        "source": {
          "type": "string",
          "enum": ["author", "translator", "editor", "unknown"],
          "description": "Who wrote this note"
        },

        "location": {
          "type": "string",
          "enum": ["page_bottom", "endnote", "margin"],
          "description": "Where the note content appears"
        },

        "content": {
          "type": "object",
          "properties": {
            "text": {"type": "string"},
            "text_preview": {
              "type": "string",
              "description": "First 100 chars for quick identification"
            },
            "content_page_index": {
              "type": "integer",
              "description": "Page where content appears (may differ from marker page for endnotes)"
            },
            "bbox": {
              "type": "array",
              "items": {"type": "number"},
              "minItems": 4,
              "maxItems": 4
            }
          }
        },

        "continuation": {
          "type": "object",
          "description": "If footnote spans multiple pages",
          "properties": {
            "continues_to_page": {"type": "integer"},
            "continues_from_page": {"type": "integer"},
            "is_complete": {"type": "boolean"}
          }
        },

        "classification_confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },

        "classification_method": {
          "type": "string",
          "enum": ["schema_based", "content_analysis", "manual"]
        }
      }
    },

    "citation": {
      "type": "object",
      "required": ["text", "citation_type"],
      "properties": {
        "text": {
          "type": "string",
          "description": "The in-text citation as it appears"
        },
        "citation_type": {
          "type": "string",
          "enum": [
            "author_year",
            "numeric",
            "footnote_reference",
            "page_reference",
            "stephanus",
            "bekker",
            "ak_reference",
            "custom"
          ]
        },
        "bbox": {
          "type": "array",
          "items": {"type": "number"},
          "minItems": 4,
          "maxItems": 4
        },
        "context": {
          "type": "string",
          "description": "Surrounding text for context"
        },
        "parsed": {
          "type": "object",
          "description": "Structured extraction of citation components",
          "properties": {
            "author": {"type": "string"},
            "year": {"type": "integer"},
            "page": {"type": "string"},
            "work_abbreviation": {"type": "string"},
            "volume": {"type": "string"}
          }
        },
        "links_to_bibliography_entry": {
          "type": "string",
          "description": "ID of the bibliography entry this cites"
        },
        "links_to_footnote": {
          "type": "string",
          "description": "ID of footnote if this is a footnote citation marker"
        }
      }
    },

    "bibliography_entry": {
      "type": "object",
      "required": ["id", "raw_text"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique ID for linking (e.g., 'bib_kant_1781')"
        },
        "raw_text": {
          "type": "string",
          "description": "The entry as it appears in the bibliography"
        },
        "page_index": {"type": "integer"},
        "parsed": {
          "type": "object",
          "properties": {
            "authors": {
              "type": "array",
              "items": {"type": "string"}
            },
            "title": {"type": "string"},
            "year": {"type": "integer"},
            "publisher": {"type": "string"},
            "place": {"type": "string"},
            "edition": {"type": "string"},
            "translator": {"type": "string"},
            "editor": {"type": "string"},
            "pages": {"type": "string"},
            "journal": {"type": "string"},
            "volume": {"type": "string"},
            "issue": {"type": "string"},
            "doi": {"type": "string"},
            "url": {"type": "string"}
          }
        },
        "entry_type": {
          "type": "string",
          "enum": ["book", "article", "chapter", "edited_volume", "translation", "dissertation", "unknown"]
        },
        "parse_confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        }
      }
    },

    "table": {
      "type": "object",
      "properties": {
        "bbox": {
          "type": "array",
          "items": {"type": "number"},
          "minItems": 4,
          "maxItems": 4
        },
        "rows": {"type": "integer"},
        "columns": {"type": "integer"},
        "has_header": {"type": "boolean"},
        "caption": {"type": "string"},
        "raw_text": {"type": "string"}
      }
    },

    "cross_reference": {
      "type": "object",
      "properties": {
        "text": {
          "type": "string",
          "description": "The reference text (e.g., 'see Chapter 3', 'cf. p. 45')"
        },
        "reference_type": {
          "type": "string",
          "enum": ["chapter", "section", "page", "figure", "table", "note", "equation"]
        },
        "target_page": {"type": "integer"},
        "target_label": {"type": "string"},
        "bbox": {
          "type": "array",
          "items": {"type": "number"},
          "minItems": 4,
          "maxItems": 4
        }
      }
    }
  }
}
